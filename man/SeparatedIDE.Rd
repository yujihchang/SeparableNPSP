% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/SeparatedIDE.R
\name{SeparatedIDE}
\alias{SeparatedIDE}
\title{Separated Direct and Indirect Effects under (Semi)Competing Risks}
\usage{
SeparatedIDE(P.time, data, type = "SP")
}
\arguments{
\item{P.time}{A numeric vector of time points at which to evaluate the difference
in the cumulative distribution function (difference in cdf). For example,
\code{c(12, 24, 36)} for 12/24/36 months.}

\item{data}{A data frame or matrix with the following required columns:
\itemize{
  \item \code{X1}: observed intermediate event times.
  \item \code{X2}: observed primary (terminal) event times.
  \item \code{D1}: indicator for the intermediate event (1 = occurred, 0 = otherwise).
  \item \code{D2}: indicator for the primary event (1 = occurred, 0 = otherwise).
  \item \code{S}: exposure level, encoded with two levels; the function internally maps
  the first observed level to 0 and the second to 1 (i.e., \code{za = 0}, \code{zb = 1}).
}}

\item{type}{Analysis setting. One of:
\itemize{
  \item \code{"SP"}: semicompeting risks method (default).
  \item \code{"CP"}: competing risks method.
}}
}
\description{
Analyzes differences in the cumulative distribution function (difference in cdf)
under semicompeting risks or competing risks settings. The procedure utilizes
Cox-type cumulative hazards (via Nelson--Aalen style increments and internal
utilities) to compute cumulative risks under different exposure levels and then
derives separable direct and indirect effect curves.
}
\details{
Internally, the function:
\enumerate{
  \item Splits the sample by exposure \code{S} (mapped to 0/1).
  \item Estimates cumulative hazards for the intermediate and terminal processes,
        including the semicompeting component when \code{type = "SP"}.
  \item Constructs counterfactual risk components and aggregates them to obtain
        \eqn{S_{00}}, \eqn{S_{10}}, \eqn{S_{11}}.
  \item Forms the separable direct effect curve \code{DE = S10 - S00} and the
        separable indirect effect curve \code{IE = S11 - S10}.
  \item Provides simple standard error curves \code{DEsd} and \code{IEsd} via a
        sandwich-style approximation based on the observed information of the
        baseline hazard increments.
}
Time points in \code{P.time} are evaluated on the same time scale as \code{X1} and \code{X2}.
Input data should be preprocessed so that times and indicators are consistent and
administrative censoring is encoded in \code{D1}/\code{D2}.
}
\value{
A list with components:
\itemize{
  \item \code{P.time}: the evaluation time grid (as provided).
  \item \code{DE}: separable direct effect curve evaluated at \code{P.time}.
  \item \code{IE}: separable indirect effect curve evaluated at \code{P.time}.
  \item \code{S10}, \code{S00}, \code{S11}: cumulative risk components under
        corresponding exposure combinations.
  \item \code{Comp_part_IE}: indirect-effect contribution from the competing part
        (\code{S11 - S10} attributable to the competing component).
  \item \code{Semi_part_IE}: indirect-effect contribution from the semicompeting part.
  \item \code{DEsd}: pointwise standard error estimates for \code{DE}.
  \item \code{IEsd}: pointwise standard error estimates for \code{IE}.
}
}
\examples{
\donttest{
## This example uses an example dataset stored as 'expdata.rda'.
## Recommended placement in a package:
##   - As a file users can load with data():   data/expdata.rda  (object named 'expdata')
##   - As a raw file to read via system.file: inst/extdata/expdata.rda
## The helper below tries both, and falls back to local files if running outside a package.

load_expdata <- function() {
  # 1) Try data(expdata) if shipped as a data object
  ok1 <- tryCatch({ data("expdata", package = "<yourPackageName>"); TRUE }, error = function(e) FALSE)
  if (ok1 && exists("expdata", inherits = FALSE)) {
    return(get("expdata"))
  }
  # 2) Try system.file under inst/extdata
  fp <- tryCatch(system.file("extdata", "expdata.rda", package = "<yourPackageName>"), error = function(e) "")
  if (!is.null(fp) && nzchar(fp) && file.exists(fp)) {
    env <- new.env(parent = emptyenv())
    load(fp, envir = env)
    # Heuristics: prefer object named 'data' or 'expdata'
    nm <- intersect(c("data", "expdata"), ls(env))
    if (length(nm) == 0L) nm <- ls(env)
    return(get(nm[1L], envir = env))
  }
  # 3) Try common local paths when examples are run from the repo
  for (p in c("data/expdata.rda", "inst/extdata/expdata.rda", "expdata.rda")) {
    if (file.exists(p)) {
      env <- new.env(parent = emptyenv())
      load(p, envir = env)
      nm <- intersect(c("data", "expdata"), ls(env))
      if (length(nm) == 0L) nm <- ls(env)
      return(get(nm[1L], envir = env))
    }
  }
  stop("Could not find 'expdata.rda'. Place it under data/ as 'expdata', or under inst/extdata/.")
}

## Load example data into an object named 'data' expected by the example code below.
tmp <- load_expdata()
if (exists("X1", where = tmp, inherits = FALSE)) {
  # If the loaded object is an environment, coerce to data.frame if possible
  data <- as.data.frame(as.list(tmp))
} else if (is.data.frame(tmp)) {
  data <- tmp
} else {
  # If the object was named 'expdata' or 'data' already as a data.frame:
  if (exists("expdata", inherits = FALSE) && is.data.frame(expdata)) data <- expdata
  if (exists("data", inherits = FALSE) && is.data.frame(data)) data <- data
}

## Ensure required columns exist (X1, X2, D1, D2, S). 'covariate' is optional but
## used below to split by its first column.
stopifnot(all(c("X1", "X2", "D1", "D2", "S") %in% names(data)))

## Time grid for evaluating separable-effect curves
P.time <- seq(0, 1.5, by = 0.01)

## Split data by the first covariate being 1 vs 0
## (Adjust if your 'covariate' is stored differently.)
if ("covariate" %in% names(data)) {
  data_1 <- data[data$covariate[, 1] == 1, ]
  data_0 <- data[data$covariate[, 1] == 0, ]
} else {
  ## If no 'covariate' is present, use S as a simple splitter for illustration.
  data_1 <- subset(data, S == 1)
  data_0 <- subset(data, S == 0)
}

## Nonparametric/semi-nonparametric separable effects (IDE-style)
Ans_1 <- SeparatedIDE(P.time, data_1, type = "SP")
Ans_0 <- SeparatedIDE(P.time, data_0, type = "SP")

## Semiparametric separable effects via Cox models (for comparison in plots).
## 'setting = "user"' + 'level = ...' pins reference covariates explicitly.
Ans.cox_0 <- Sepable_cox(
  p.time   = P.time,
  z.level  = c(0, 1),
  data     = data,
  setting  = "user",
  level    = c(0, 0),
  type     = "SP"
)
Ans.cox_1 <- Sepable_cox(
  p.time   = P.time,
  z.level  = c(0, 1),
  data     = data,
  setting  = "user",
  level    = c(1, 0),
  type     = "SP"
)

## Plot: DE/IE given covariate at level 0 or 1, comparing IDE vs Cox approaches
op <- par(mfrow = c(2, 2))

## --- Plot 1: DE given covariate = 0 ---
## y-axis: DE given covariate at level 0
plot(P.time, Ans_0$DE, type = "s", col = 1,
     xlab = "Time", ylab = "Direct Effect (DE) given covariate = 0",
     main = "DE | covariate = 0")
points(P.time, Ans.cox_0$DE, type = "s", col = 2)
legend("topleft", bty = "n", lty = 1, col = c(1, 2),
       legend = c("SeparatedIDE (nonparametric)", "Separable Cox (semiparametric)"))

## --- Plot 2: IE given covariate = 0 ---
## y-axis: IE given covariate at level 0
plot(P.time, Ans_0$IE, type = "s", col = 1,
     xlab = "Time", ylab = "Indirect Effect (IE) given covariate = 0",
     main = "IE | covariate = 0")
points(P.time, Ans.cox_0$IE, type = "s", col = 2)

## --- Plot 3: DE given covariate = 1 ---
## y-axis: DE given covariate at level 1
plot(P.time, Ans_1$DE, type = "s", col = 1,
     xlab = "Time", ylab = "Direct Effect (DE) given covariate = 1",
     main = "DE | covariate = 1")
points(P.time, Ans.cox_1$DE, type = "s", col = 2)

## --- Plot 4: IE given covariate = 1 ---
## y-axis: IE given covariate at level 1
plot(P.time, Ans_1$IE, type = "s", col = 1,
     xlab = "Time", ylab = "Indirect Effect (IE) given covariate = 1",
     main = "IE | covariate = 1")
points(P.time, Ans.cox_1$IE, type = "s", col = 2)

par(op)
}
}
\keyword{survival}
\keyword{mediation}
\keyword{semicompeting-risks}

